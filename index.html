<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Radio France Streamers</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.3.2/dist/hls.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>
  <style>
    /* Hide the video element completely */
    #my-video {
      display: none;
    }
    body {
      font-family: sans-serif;
      margin: 5px; /* Reduced margin */
      padding: 0;
      background-color: #f0f0f0;
      color: #333;
      overflow-x: hidden; /* Prevent horizontal scrollbar from mouse edge detection */
    }
    #metadataMessage {
      font-size: 0.8em; /* Further reduced font size */
      margin-bottom: 5px; /* Reduced margin */
      color: #555;
    }
    #station-list {
      list-style: none;
      padding: 0;
      margin: 0 0 10px 0; /* Reduced margin */
    }
    #station-list li {
      margin-bottom: 3px; /* Reduced gap between items */
    }
    #station-list a {
      display: block;
      padding: 6px 8px; /* Reduced padding for smaller buttons */
      background-color: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 0.8em; /* Further reduced font size */
      text-align: center;
    }
    /* Highlighted station style */
    #station-list a.highlighted {
      background-color: #ffc107; /* Yellow highlight */
      color: #333;
      border: 1px solid #e0a800;
    }
    button {
      width: 100%;
      padding: 8px 0; /* Reduced padding for smaller button */
      font-size: 0.9em; /* Further reduced font size */
      margin-bottom: 8px; /* Reduced margin */
      border: none;
      border-radius: 4px;
      background-color: #28a745;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #218838;
    }
    #page-nav-buttons, #list-nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    #page-nav-buttons button, #list-nav-buttons button {
      width: 48%; /* Roughly half width for two buttons */
      margin-bottom: 0;
      padding: 6px 0; /* Slightly smaller than main play/pause button */
      font-size: 0.85em;
    }
     #list-nav-buttons button {
        background-color: #6c757d; /* Different color for list navigation */
    }
    #list-nav-buttons button:hover {
        background-color: #5a6268;
    }
  </style>
</head>

<body>

  <p id="metadataMessage">Radio France player v1.4: </p>

  <div id="list-nav-buttons">
    <button id="upBtn">Up (2)</button>
    <button id="downBtn">Down (8)</button>
  </div>

  <ul id="station-list">
    </ul>

  <div id="page-nav-buttons">
    <button id="prevPageBtn">&lt; Previous Page (4)</button>
    <button id="nextPageBtn">Next Page (6) &gt;</button>
  </div>

  <button id="playPauseButton">Play</button>

  <video id="my-video" controls playsinline></video>

  <script>
    // Changed to 'let' so HLS instance can be re-assigned
    let hls;
    const video = document.getElementById('my-video');

    // Function to initialize/reinitialize HLS instance
    function initializeHLS() {
      if (hls) { // If an HLS instance already exists, destroy it first
        hls.destroy();
      }
      hls = new Hls(); // Create a new HLS instance
      hls.attachMedia(video); // Attach the new instance to the video element
    }

    // Call initializeHLS once at the very beginning to set up the first HLS instance
    initializeHLS();

    const stationList = document.getElementById('station-list');
    const playPauseButton = document.getElementById('playPauseButton');
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const upBtn = document.getElementById('upBtn');
    const downBtn = document.getElementById('downBtn');

    // All stations data, including which 'page' they belong to
    const allStations = [
      // Page 1 Stations (page: 0)
      { id: 'france-inter', name: 'France Inter', url: 'https://stream.radiofrance.fr/franceinter/franceinter.m3u8?id=radiofranceBose', page: 0, cue: 'France Inter cue.mp3' },
      { id: 'franceinfo', name: 'Franceinfo', url: 'https://stream.radiofrance.fr/franceinfo/franceinfo.m3u8?id=radiofranceBose', page: 0, cue: 'France info cue.mp3' },
      { id: 'france-culture', name: 'France Culture', url: 'https://stream.radiofrance.fr/franceculture/franceculture.m3u8?id=radiofranceBose', page: 0, cue: 'France culture cue.mp3' },
      // Page 2 Stations (page: 1)
      { id: 'la-musique-d-inter', name: 'La Musique d\'Inter', url: 'https://stream.radiofrance.fr/franceinterlamusiqueinter/franceinterlamusiqueinter.m3u8?id=radiofranceBose', page: 1 },
      { id: 'fip', name: 'FIP', url: 'https://stream.radiofrance.fr/fip/fip.m3u8?id=radiofranceBose', page: 1 },
      { id: 'fip-rock-new', name: 'FIP Rock (2)', url: 'https://stream.radiofrance.fr/fiprock/fiprock.m3u8?id=radiofranceBose', page: 1 },
      { id: 'fip-jazz', name: 'FIP Jazz', url: 'https://stream.radiofrance.fr/fipjazz/fipjazz.m3u8?id=radiofranceBose', page: 1 },
      { id: 'fip-groove', name: 'FIP Groove', url: 'https://stream.radiofrance.fr/fipgroove/fipgroove.m3u8?id=radiofranceBose', page: 1 },
      { id: 'fip-monde', name: 'FIP Monde', url: 'https://stream.radiofrance.fr/fipworld/fipworld.m3u8?id=radiofranceBose', page: 1 },
      { id: 'fip-nouveautes', name: 'FIP Nouveautés', url: 'https://stream.radiofrance.fr/fipnouveautes/fipnouveautes.m3u8?id=radiofranceBose', page: 1 },
      { id: 'fip-reggae', name: 'FIP Reggae', url: 'https://stream.radiofrance.fr/fipreggae/fipreggae.m3u8?id=radiofranceBose', page: 1 },
      { id: 'fip-electro', name: 'FIP Electro', url: 'https://stream.radiofrance.fr/fipelectro/fipelectro.m3u8?id=radiofranceBose', page: 1 },
      { id: 'fip-metal', name: 'FIP Metal', url: 'https://stream.radiofrance.fr/fipmetal/fipmetal.m3u8?id=radiofranceBose', page: 1 },
      { id: 'fip-pop', name: 'FIP Pop', url: 'https://stream.radiofrance.fr/fippop/fippop.m3u8?id=radiofranceBose', page: 1 },
      { id: 'fip-hiphop', name: 'FIP Hip Hop', url: 'https://stream.radiofrance.fr/fiphiphop/fiphiphop.m3u8?id=radiofranceBose', page: 1 },
      { id: 'fip-sacre-francais', name: 'FIP Sacré Français', url: 'https://stream.radiofrance.fr/fipsacrefrancais/fipsacrefrancais.m3u8?id=radiofranceBose', page: 1 }
    ];

    let currentPage = 0;
    const maxPage = Math.max(...allStations.map(s => s.page));
    let currentPlayingStationGlobalIndex = -1;
    let highlightedStationIndexOnPage = 0;

    // Howler.js instances for specific cues
    const stationCues = {};
    allStations.forEach(station => {
      if (station.cue) {
        stationCues[station.id] = new Howl({
          src: [station.cue],
          html5: true,
          preload: true
        });
      }
    });

    // Function to update Media Session metadata
    function updateMediaSessionMetadata(title, artist, album, artwork) {
      if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
          title: title,
          artist: artist,
          album: album,
          artwork: [
            { src: artwork, sizes: '512x512', type: 'image/png' }
          ]
        });

        navigator.mediaSession.setActionHandler('play', () => {
          video.play();
          playPauseButton.textContent = "Pause";
        });
        navigator.mediaSession.setActionHandler('pause', () => {
          video.pause();
          playPauseButton.textContent = "Play";
        });
        // Media session next/previous track should still navigate through ALL stations globally
        navigator.mediaSession.setActionHandler('nexttrack', playNextStation);
        navigator.mediaSession.setActionHandler('previoustrack', playPreviousStation);
      }
    }

    // Function to play a station by its global index
    function playStation(globalIndex) {
      if (globalIndex >= 0 && globalIndex < allStations.length) {
        const station = allStations[globalIndex];
        const url = station.url;
        const radiotitle = station.name;

        // Pause any currently playing video stream
        video.pause();

        // Ensure HLS instance is fresh and ready for a new source
        initializeHLS();

        const cueToPlay = stationCues[station.id];

        if (cueToPlay) {
          // If there's a specific cue for this station, play it
          cueToPlay.stop(); // Stop any currently playing cue (if rapid switching)
          cueToPlay.off('end'); // Remove previous end listener to prevent multiple calls
          cueToPlay.once('end', () => {
            // After cue ends, start the live stream
            hls.loadSource(url);
            video.play(); // Play the video element
          });
          cueToPlay.play();
        } else {
          // If no specific cue, directly load and play the live stream
          hls.loadSource(url);
          video.play(); // Play the video element
        }

        // Update display and highlight
        if (station.page !== currentPage) {
          currentPage = station.page;
          const stationsOnNewPage = allStations.filter(s => s.page === currentPage);
          highlightedStationIndexOnPage = stationsOnNewPage.length > 0 ? stationsOnNewPage.findIndex(s => s.id === station.id) : 0;
          if(highlightedStationIndexOnPage === -1 && stationsOnNewPage.length > 0) highlightedStationIndexOnPage = 0; // Default to 0 if not found
          renderStationsForPage(currentPage);
        } else {
            const stationsOnCurrentPage = allStations.filter(s => s.page === currentPage);
            highlightedStationIndexOnPage = stationsOnCurrentPage.length > 0 ? stationsOnCurrentPage.findIndex(s => s.id === station.id) : 0;
            if(highlightedStationIndexOnPage === -1 && stationsOnCurrentPage.length > 0) highlightedStationIndexOnPage = 0; // Default to 0 if not found
            updateHighlight();
        }

        // Update metadata message
        document.getElementById('metadataMessage').textContent = `Now playing: ${radiotitle}`;

        // Update Media Session metadata
        updateMediaSessionMetadata(radiotitle, "Radio France", "Live Stream", "https://www.logotheque-vectorielle.fr/wp-content/uploads/2023/11/logo-vectoriel-radio-france.jpg");

        // Update current playing index
        currentPlayingStationGlobalIndex = globalIndex;

        // Update Play/Pause button text
        playPauseButton.textContent = "Pause";
      }
    }

    // Function to play the next station in the allStations list (for global next/prev track)
    function playNextStation() {
      const nextIndex = (currentPlayingStationGlobalIndex + 1) % allStations.length;
      playStation(nextIndex);
    }

    // Function to play the previous station in the allStations list (for global next/prev track)
    function playPreviousStation() {
      const previousIndex = (currentPlayingStationGlobalIndex - 1 + allStations.length) % allStations.length;
      playStation(previousIndex);
    }

    // Function to update the visual highlight on the current page
    function updateHighlight() {
        const visibleLinks = stationList.querySelectorAll('a');
        visibleLinks.forEach((link, index) => {
            if (index === highlightedStationIndexOnPage) {
                link.classList.add('highlighted');
                // Scroll into view if needed
                link.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                link.classList.remove('highlighted');
            }
        });
    }

    // Function to render stations for the given page index
    function renderStationsForPage(pageIndex) {
      stationList.innerHTML = ''; // Clear current list

      const stationsOnPage = allStations.filter(station => station.page === pageIndex);

      // Reset highlight if previous index is out of bounds for new page
      if (stationsOnPage.length === 0) {
          highlightedStationIndexOnPage = -1;
      } else if (highlightedStationIndexOnPage >= stationsOnPage.length || highlightedStationIndexOnPage < 0) {
          highlightedStationIndexOnPage = 0; // Default to first item if invalid
      }


      stationsOnPage.forEach((station, index) => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.id = station.id;
        a.href = "#"; // Prevent default navigation
        a.textContent = station.name;

        // Add highlight class if it's the currently highlighted station
        if (index === highlightedStationIndexOnPage) {
            a.classList.add('highlighted');
        }

        a.addEventListener('click', (event) => {
          event.preventDefault();
          const globalIndex = allStations.findIndex(s => s.id === station.id);
          playStation(globalIndex);
          highlightedStationIndexOnPage = index; // Update highlight after direct click
          updateHighlight();
        });
        li.appendChild(a);
        stationList.appendChild(li);
      });

      // Ensure the highlighted item is in view after re-rendering
      updateHighlight();
    }

    // --- List Navigation Functions (Up/Down) ---
    function moveHighlight(direction) {
        const stationsOnPage = allStations.filter(station => station.page === currentPage);
        if (stationsOnPage.length === 0) return; // No stations to highlight

        if (direction === 'down') {
            highlightedStationIndexOnPage = (highlightedStationIndexOnPage + 1) % stationsOnPage.length;
        } else if (direction === 'up') {
            highlightedStationIndexOnPage = (highlightedStationIndexOnPage - 1 + stationsOnPage.length) % stationsOnPage.length;
        }

        updateHighlight(); // Update visual highlight

        // Automatically play the highlighted station
        const highlightedStationOnPage = stationsOnPage[highlightedStationIndexOnPage];
        const globalIndexToPlay = allStations.findIndex(s => s.id === highlightedStationOnPage.id);
        playStation(globalIndexToPlay);
    }


    // --- Page Navigation Functions (Left/Right) ---
    function goToNextPage() {
      if (currentPage < maxPage) {
        currentPage++;
        highlightedStationIndexOnPage = 0; // Reset highlight on new page
        renderStationsForPage(currentPage);
      } else {
        // Optionally wrap around to the first page
        currentPage = 0;
        highlightedStationIndexOnPage = 0;
        renderStationsForPage(currentPage);
      }
    }

    function goToPreviousPage() {
      if (currentPage > 0) {
        currentPage--;
        highlightedStationIndexOnPage = 0; // Reset highlight on new page
        renderStationsForPage(currentPage);
      } else {
        // Optionally wrap around to the last page
        currentPage = maxPage;
        highlightedStationIndexOnPage = 0;
        renderStationsForPage(currentPage);
      }
    }

    // --- Event Listeners ---

    // Initial render of the first page
    renderStationsForPage(currentPage);

    // Event listener for Play/Pause button
    playPauseButton.addEventListener('click', () => {
      if (video.paused) {
        // If nothing is playing and a station is highlighted, play the highlighted one
        const stationsOnPage = allStations.filter(s => s.page === currentPage);
        if (currentPlayingStationGlobalIndex === -1 && stationsOnPage.length > 0 && highlightedStationIndexOnPage >= 0 && highlightedStationIndexOnPage < stationsOnPage.length) {
            const stationToPlay = stationsOnPage[highlightedStationIndexOnPage];
            const globalIndex = allStations.findIndex(s => s.id === stationToPlay.id);
            playStation(globalIndex);
        } else {
            video.play(); // Continue playing if paused, or attempt to play existing stream
        }
      } else {
        video.pause();
      }
    });

    // Update Play/Pause button state when playback is paused or resumed
    video.addEventListener('play', () => {
      playPauseButton.textContent = "Pause";
    });

    video.addEventListener('pause', () => {
      playPauseButton.textContent = "Play";
    });

    // Page navigation button listeners
    nextPageBtn.addEventListener('click', goToNextPage);
    prevPageBtn.addEventListener('click', goToPreviousPage);

    // List navigation button listeners
    upBtn.addEventListener('click', () => moveHighlight('up'));
    downBtn.addEventListener('click', () => moveHighlight('down'));


    // Key event listener for keyboard
    document.addEventListener('keydown', (event) => {
      // Use event.which || event.keyCode for broader compatibility
      const keyCode = event.which || event.keyCode;

      // Keystroke 0 (Play/Pause)
      if (keyCode === 48) { // 0 key
        event.preventDefault();
        playPauseButton.click();
      }

      // Arrow Keys (New Mapping)
      if (keyCode === 38) { // ArrowUp
        event.preventDefault();
        moveHighlight('up');
      }
      if (keyCode === 40) { // ArrowDown
        event.preventDefault();
        moveHighlight('down');
      }
      if (keyCode === 39) { // ArrowRight (for Next Page)
        event.preventDefault();
        goToNextPage();
      }
      if (keyCode === 37) { // ArrowLeft (for Previous Page)
        event.preventDefault();
        goToPreviousPage();
      }

      // Numpad Keys (retained as alternatives)
      if (keyCode === 102) { // Numpad 6
        event.preventDefault();
        goToNextPage();
      }
      if (keyCode === 100) { // Numpad 4
        event.preventDefault();
        goToPreviousPage();
      }
      if (keyCode === 98) { // Numpad 2
        event.preventDefault();
        moveHighlight('up');
      }
      if (keyCode === 104) { // Numpad 8
        event.preventDefault();
        moveHighlight('down');
      }
    });

    // Mouse Edge Slide for Page Navigation (with debounce)
    let lastPageSwitchTime = 0;
    const PAGE_SWITCH_COOLDOWN = 500; // milliseconds to prevent rapid switching
    const EDGE_THRESHOLD = 20; // Pixels from the edge to trigger

    document.addEventListener('mousemove', (event) => {
      const now = Date.now();
      if (now - lastPageSwitchTime < PAGE_SWITCH_COOLDOWN) {
        return; // Too soon for another page switch
      }

      const screenWidth = window.innerWidth;
      const mouseX = event.clientX;

      if (mouseX > screenWidth - EDGE_THRESHOLD && currentPage < maxPage) {
        lastPageSwitchTime = now;
        goToNextPage();
      } else if (mouseX < EDGE_THRESHOLD && currentPage > 0) {
        lastPageSwitchTime = now;
        goToPreviousPage();
      }
    });
  </script>
</body>
</html>
